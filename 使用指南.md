# @cursor start
# AIä»£ç å®¡æŸ¥GitLabæœºå™¨äºº - ä½¿ç”¨æŒ‡å—

## ğŸ¯ é¡¹ç›®ç®€ä»‹

è¿™æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„AIä»£ç å®¡æŸ¥å·¥å…·ï¼Œå½“ä½ åœ¨GitLabä¸­åˆ›å»ºMerge Requestæ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨ä½¿ç”¨AIæ¨¡å‹å®¡æŸ¥ä»£ç å¹¶æä¾›å»ºè®®ã€‚

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
ai-code-review-gitlab/
â”œâ”€â”€ app.py              # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ config.py           # é…ç½®æ–‡ä»¶
â”œâ”€â”€ gitlab_client.py    # GitLab APIå®¢æˆ·ç«¯
â”œâ”€â”€ ai_client.py        # AIå¤§æ¨¡å‹å®¢æˆ·ç«¯
â”œâ”€â”€ code_reviewer.py    # ä»£ç å®¡æŸ¥é€»è¾‘
â”œâ”€â”€ requirements.txt    # ä¾èµ–åŒ…
â”œâ”€â”€ start.sh           # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ README.md          # è¯´æ˜æ–‡æ¡£
â””â”€â”€ ä½¿ç”¨æŒ‡å—.md        # æœ¬æ–‡ä»¶
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. è·å–GitLabè®¿é—®ä»¤ç‰Œ

1. ç™»å½•ä½ çš„GitLabè´¦æˆ·
2. ç‚¹å‡»å³ä¸Šè§’å¤´åƒ â†’ Settings
3. å·¦ä¾§èœå•é€‰æ‹© "Access Tokens"
4. åˆ›å»ºæ–°tokenï¼š
   - **Token name**: `ai-code-review`
   - **Expiration date**: é€‰æ‹©è¿‡æœŸæ—¶é—´
   - **Scopes**: å‹¾é€‰ `api`, `read_user`, `read_repository`, `write_repository`
5. ç‚¹å‡» "Create personal access token"
6. å¤åˆ¶ç”Ÿæˆçš„tokenï¼ˆæ ¼å¼ï¼š`glpat-xxxxxxxxxxxxxxxxxxxx`ï¼‰

### 2. è·å–AIæ¨¡å‹APIå¯†é’¥

#### OpenAI GPT
1. è®¿é—®ï¼šhttps://platform.openai.com/api-keys
2. åˆ›å»ºAPIå¯†é’¥ï¼ˆæ ¼å¼ï¼š`sk-xxxxxxxxxxxxxxxxxxxx`ï¼‰

#### DeepSeekï¼ˆå¯é€‰ï¼‰
1. è®¿é—®ï¼šhttps://platform.deepseek.com/
2. æ³¨å†Œå¹¶è·å–APIå¯†é’¥

### 3. é…ç½®é¡¹ç›®

1. å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿æ–‡ä»¶ï¼š
```bash
cp env.example .env
```

2. ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œå¡«å…¥ä½ çš„çœŸå®é…ç½®ï¼š

```bash
# GitLabé…ç½®
GITLAB_URL=https://gitlab.com
GITLAB_TOKEN=glpat-your-token-here

# AIæ¨¡å‹é…ç½® - æ”¯æŒå¤šç§å‚å•†
AI_PROVIDER=siliconflow

# ç¡…æµé…ç½® (SiliconFlow)
SILICONFLOW_API_KEY=your-siliconflow-api-key-here
SILICONFLOW_MODEL=Qwen/Qwen2.5-72B-Instruct

# é˜¿é‡Œäº‘é€šä¹‰åƒé—®é…ç½® (å¯é€‰)
ALIYUN_API_KEY=your-aliyun-api-key-here
ALIYUN_MODEL=qwen2.5-72b-instruct

# OpenAIé…ç½® (å¯é€‰)
OPENAI_API_KEY=sk-your-openai-key-here
OPENAI_MODEL=gpt-4o
```

**âš ï¸ é‡è¦æé†’ï¼š**
- `.env` æ–‡ä»¶åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œä¸ä¼šè¢«æäº¤åˆ°Git
- `config.py` æ–‡ä»¶ä¼šä»ç¯å¢ƒå˜é‡è¯»å–é…ç½®ï¼Œæ— éœ€ä¿®æ”¹
- è¯·ç¡®ä¿ä¸è¦å°†çœŸå®çš„APIå¯†é’¥æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ

### 4. å¯åŠ¨æœåŠ¡

```bash
# ä½¿ç”¨å¯åŠ¨è„šæœ¬
./start.sh

# æˆ–ç›´æ¥è¿è¡Œ
python3 app.py
```

### 5. é…ç½®GitLab Webhook

1. è¿›å…¥ä½ çš„GitLabé¡¹ç›®
2. Settings â†’ Webhooks â†’ Add new webhook
3. é…ç½®ï¼š
   - **URL**: `http://ä½ çš„æœåŠ¡å™¨IP:8080/webhook`
   - **Secret token**: ç•™ç©º
   - **Trigger**: é€‰æ‹© `Merge request events`
   - **SSL verification**: æ ¹æ®ä½ çš„æœåŠ¡å™¨é…ç½®é€‰æ‹©
4. ç‚¹å‡» "Add webhook"

## ğŸ”§ å·¥ä½œåŸç†

### 1. äº‹ä»¶è§¦å‘
å½“ä½ åœ¨GitLabä¸­åˆ›å»ºMerge Requestæ—¶ï¼ŒGitLabä¼šå‘é€webhookåˆ°æˆ‘ä»¬çš„æœåŠ¡ã€‚

### 2. äº‹ä»¶å¤„ç†
```python
@app.route('/webhook', methods=['POST'])
def webhook():
    webhook_data = request.get_json()
    # æ£€æŸ¥æ˜¯å¦æ˜¯Merge Requestæ‰“å¼€äº‹ä»¶
    # æå–é¡¹ç›®IDå’ŒMR ID
    # å¯åŠ¨å¼‚æ­¥å®¡æŸ¥
```

### 3. ä»£ç è·å–
```python
# è·å–Merge Requestçš„ä»£ç å˜æ›´
changes = gitlab_client.get_merge_request_changes(project_id, mr_iid)
```

### 4. AIå®¡æŸ¥
```python
# æ ¼å¼åŒ–ä»£ç å˜æ›´
formatted_changes = code_reviewer.format_code_changes(changes)
# ä½¿ç”¨AIæ¨¡å‹å®¡æŸ¥
review_result = ai_client.review_code(formatted_changes)
```

### 5. ç»“æœå‘é€
```python
# å°†å®¡æŸ¥ç»“æœæ·»åŠ ä¸ºè¯„è®º
gitlab_client.add_comment(project_id, mr_iid, review_result)
```

## ğŸ“‹ é…ç½®é€‰é¡¹

### æ–‡ä»¶ç±»å‹è¿‡æ»¤
```python
# éœ€è¦å®¡æŸ¥çš„æ–‡ä»¶ç±»å‹
REVIEW_FILE_TYPES = ['.py', '.js', '.ts', '.java', '.go', '.cpp', '.c', '.php']

# å¿½ç•¥çš„æ–‡ä»¶ç±»å‹
IGNORE_FILE_TYPES = ['package-lock.json', 'yarn.lock', 'mod.go']
```

### æ€§èƒ½é™åˆ¶
```python
# æœ€å¤§å¤„ç†æ–‡ä»¶æ•°é‡
MAX_FILES = 50

# ä¸Šä¸‹æ–‡ä»£ç è¡Œæ•°
CONTEXT_LINES = 5
```

### å®¡æŸ¥æç¤ºè¯
```python
REVIEW_PROMPT = """
ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ä»£ç å®¡æŸ¥ä¸“å®¶ã€‚è¯·å¯¹ä»¥ä¸‹ä»£ç å˜æ›´è¿›è¡Œå®¡æŸ¥ï¼Œå¹¶æä¾›è¯¦ç»†çš„å»ºè®®ã€‚

è¯·ä»ä»¥ä¸‹æ–¹é¢è¿›è¡Œå®¡æŸ¥ï¼š
1. ä»£ç è´¨é‡å’Œå¯è¯»æ€§
2. å®‰å…¨æ€§é—®é¢˜
3. æ€§èƒ½ä¼˜åŒ–
4. æœ€ä½³å®è·µ
5. æ½œåœ¨çš„bug

ä»£ç å˜æ›´å†…å®¹ï¼š
{code_changes}
"""
```

## ğŸ” æµ‹è¯•æ–¹æ³•

### 1. å¥åº·æ£€æŸ¥
```bash
curl http://localhost:8080/health
```

### 2. é¦–é¡µä¿¡æ¯
```bash
curl http://localhost:8080/
```

### 3. æ‰‹åŠ¨æµ‹è¯•webhook
```bash
curl -X POST http://localhost:8080/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "object_kind": "merge_request",
    "project": {"id": 123},
    "object_attributes": {"iid": 456, "state": "opened"}
  }'
```

## ğŸ› å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•è·å–GitLabé¡¹ç›®IDï¼Ÿ
åœ¨GitLabé¡¹ç›®é¡µé¢ï¼Œé¡¹ç›®IDæ˜¾ç¤ºåœ¨é¡¹ç›®åç§°ä¸‹æ–¹ï¼Œæˆ–è€…æŸ¥çœ‹é¡¹ç›®è®¾ç½®é¡µé¢ã€‚

### Q2: å¦‚ä½•è·å–Merge Request IDï¼Ÿ
åœ¨Merge Requesté¡µé¢ï¼ŒIDæ˜¾ç¤ºåœ¨æ ‡é¢˜æ—è¾¹ï¼Œæ ¼å¼å¦‚ `!123`ã€‚

### Q3: Webhookæ— æ³•è§¦å‘æ€ä¹ˆåŠï¼Ÿ
1. æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™æ˜¯å¦å¼€æ”¾8080ç«¯å£
2. æ£€æŸ¥webhook URLæ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹GitLab webhookæ—¥å¿—
4. æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—

### Q4: AIå®¡æŸ¥å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
1. æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. æ£€æŸ¥APIé…é¢æ˜¯å¦ç”¨å®Œ
4. æŸ¥çœ‹é”™è¯¯æ—¥å¿—

### Q5: å¦‚ä½•åˆ‡æ¢AIæ¨¡å‹ï¼Ÿ
åœ¨ `app.py` ä¸­ä¿®æ”¹ï¼š
```python
ai_client = AIClient(model_type="deepseek")  # æ”¹ä¸º "deepseek"
```

## ğŸš€ æ‰©å±•åŠŸèƒ½

### 1. æ·»åŠ æ–°çš„å¤§æ¨¡å‹
åœ¨ `ai_client.py` ä¸­æ·»åŠ æ–°çš„æ¨¡å‹æ”¯æŒï¼š
```python
def _review_with_custom_model(self, code_changes):
    # å®ç°è‡ªå®šä¹‰æ¨¡å‹çš„è°ƒç”¨é€»è¾‘
    pass
```

### 2. è‡ªå®šä¹‰å®¡æŸ¥è§„åˆ™
åœ¨ `code_reviewer.py` ä¸­ä¿®æ”¹ `should_review_file` æ–¹æ³•ï¼š
```python
def should_review_file(self, file_path):
    # æ·»åŠ è‡ªå®šä¹‰çš„å®¡æŸ¥è§„åˆ™
    pass
```

### 3. æ·»åŠ é€šçŸ¥åŠŸèƒ½
å¯ä»¥æ‰©å±•æ”¯æŒé’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ç­‰é€šçŸ¥æ–¹å¼ã€‚

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š
1. æŸ¥çœ‹é¡¹ç›®æ—¥å¿—
2. æ£€æŸ¥é…ç½®æ–‡ä»¶
3. æŸ¥çœ‹GitLab webhookæ—¥å¿—
4. æ£€æŸ¥ç½‘ç»œè¿æ¥

è¿™ä¸ªç®€åŒ–ç‰ˆæœ¬ä¿ç•™äº†æ ¸å¿ƒåŠŸèƒ½ï¼Œä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œæ‰©å±•ï¼
# @cursor end 